---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(bccamtrap)
library(dplyr)
```

# bccamtrap

<!-- badges: start -->
[![R-CMD-check](https://github.com/ateucher/bccamtrap/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/ateucher/bccamtrap/actions/workflows/R-CMD-check.yaml)
[![img](https://img.shields.io/badge/Lifecycle-Experimental-339999)](https://github.com/bcgov/repomountie/blob/master/doc/lifecycle-badges.md)
[![Codecov test coverage](https://codecov.io/gh/bcgov/bccamtrap/branch/main/graph/badge.svg)](https://app.codecov.io/gh/bcgov/bccamtrap?branch=main)
<!-- badges: end -->

Functions for QA and validation of Camera Trap data

## Installation

You can install the development version of bccamtrap from [GitHub](https://github.com/) using 
the [devtools](https://devtools.r-lib.org/) package (you may need to install it first):

``` r
# install.packages("devtools")
devtools::install_github("bcgov/bccamtrap")
```

## Example Usage

This package is being developed for camera trap studies in the West Coast Region, 
BC Ministry of Water, Land, and Resource Stewardship (WLRS).

The functions in this package currently assume your project and session-level data
are stored in a BC Government [Wildlife Data Submission Template](https://www2.gov.bc.ca/gov/content?id=DC67BCBF8B1E462889B854364364D2D1) for Camera Trap Data,
augmented with additional fields.

The image data is expected to be in multiple csv files, in one folder per project.
The csv files have been generated by reviewing the images in [TimeLapse](https://saul.cpsc.ucalgary.ca/timelapse/) software, using
the template `v20230518`.

To begin, set the paths to the project metadata file, and the folder containing the
TimeLapse image files:

```{r}
#| eval: false
library(bccamtrap)

metadata_path <- "~/data/project-files/project_1_RISC_WCR_Database_Template_v20230518.xlsm"
data_path <- "~/data/wc-wlrs-cam-data/camera-data/project_1/"
```


```{r}
#| include: false

googledrive::drive_auth(path = Sys.getenv("GDRIVE_AUTH_TOKEN"))

drv <- googledrive::drive_get(id = "1JC_zaIuazGThq7fxnCPZ0wVhv7tIytFs")

temp_dir <- withr::local_tempdir(
  pattern = "bccamtrap_readme"
)

zip_file <- googledrive::drive_download(
  drv,
  file.path(temp_dir, drv$name),
  overwrite = TRUE
)

temp_dir_1 <- tools::file_path_sans_ext(zip_file$local_path)
unzip(zip_file$local_path, exdir = dirname(temp_dir_1))

files <- list.files(temp_dir_1, full.names = TRUE)
merged_files <- grep("merged", files, value = TRUE)
file.remove(merged_files)
files <- setdiff(files, merged_files)

data_path <- temp_dir_1
metadata_path <- grep(".xls[xm]?$", files, value = TRUE)

# Dummy print methods to drop any sensitive info
print.sample_station_info <- function(x, ...) {
  x <- sf::st_drop_geometry(x) %>% 
    select(-contains(c("utm", "easting", "northing", "dd")))
  print(as_tibble(x))
}

print.sample_sessions <- print.sample_station_info
```

### Project and station metadata

Read in project metadata from the SPI worksheet. There are functions to read
the relevant tabs:

### Project Information

```{r}
proj <- read_project_info(metadata_path)
proj
```

#### Sample station information

Read the sample station information. This creates a spatial data frame of class
`"sf"`, from the [sf](https://r-spatial.github.io/sf/) package. This format allows
us to work with it as a regular data frame, but also do spatial things with it.

```{r}
sample_stations <- read_sample_station_info(metadata_path)
sample_stations
```

Use the `check_stations_spatial()` function to run some basic spatial validation
on the data - namely checking for spatial outliers:

```{r}
sample_stations <- check_stations_spatial(sample_stations)
```

Use the `summary()` method for Sample Station Info for basic descritive stats:

```{r}
summary(sample_stations)
```

Use the `map_stations()` function to create an interactive map the of the stations. This 
will show any potential outlying stations, indicating possible data errors:

```{r}
map_stations(sample_stations)
```

#### Camera Setup and Checks:

```{r}
camera_setup_checks <- read_cam_setup_checks(metadata_path)
camera_setup_checks
```

#### Sample Sessions (deployments)

Rather than just looking at the raw camera setup and checks or stations, there is more utility in assembling sampling sessions by combining the sample station information and the camera setup and checks. Do this with the `make_sample_sessions()` function.

```{r}
sessions <- make_sample_sessions(metadata_path)
sessions
```

There is a handy `summary()` method for this as well:

```{r}
summary(sessions)
```

We can use the [mapview](https://r-spatial.github.io/mapview/) package to quickly visualize this, setting the `zcol` argument to the name of the column you'd like to colour the points by. Clicking on a point will give you the details of that sample session.

```{r}
library(mapview)
mapview(sessions, zcol = "sample_station_label")
```

### Image data

We can read in an entire directory of image data from multiple csv files, as long
as they all follow the same TimeLapse template. Currently it is expected that
they follow the `v20230518` template.

```{r}
image_data <- read_image_data(data_path)
image_data
```

Again, we can use the `summary()` method to get an overview of the image data.

```{r}
summary(image_data)
```

Use the `check_deployment_images()` function to find deployment labels that are 
in the sample session data but not in the image data, and vice-versa. It is usually
likely that there will be deployment labels in the sample session data that are missing
from the image data if not all of the images have been processed yet. Deployment
labels that are present in the image data but not in the sample session data indicate
a potential problem.

```{r}
check_deployment_images(sessions, image_data)
```

### Plots

#### Deployment plot

We can plot deployments to see that the start and ends of our deployments are 
as expected, and flag any "invalid" sessions (i.e., where we don't know the end 
time because a camera was stolen, bumped, ran out of batteries etc.). You can 
make static or interactive plots:

```{r}
plot_deployments(sessions, date_breaks = "2 months")
plot_deployments(sessions, interactive = TRUE, date_breaks = "2 months")
```

#### Detection plot

We can also plot image timestamps over the deployment durations to alert us to 
potential time mismatches between the session data and image time labels:

```{r}
plot_deployment_detections(sessions, image_data, date_breaks = "2 months")
plot_deployment_detections(sessions, image_data, interactive = TRUE, date_breaks = "2 months")
```

#### Daily detection patterns

We can plot the patterns of daily detections by species:

```{r}
plot_diel_activity(image_data)
plot_diel_activity(image_data, interactive = TRUE)
```


### Project Status

### Getting Help or Reporting an Issue

To report bugs/issues/feature requests, please file an [issue](https://github.com/bcgov/bccamtrap/issues/).

### How to Contribute

If you would like to contribute, please see our [CONTRIBUTING](CONTRIBUTING.md) guidelines.

Please note that this project is released with a [Contributor Code of Conduct](CODE_OF_CONDUCT.md). By participating in this project you agree to abide by its terms.

### License

```
Copyright 2024 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
```
